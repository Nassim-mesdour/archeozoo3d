var texture,texture3,camera,controls,controlObject,scene,renderer,canvas,canvas_container,gridHelper,boxHelper,gui,customContainer,requestAnimation,holeGeo,holePlane,holeBaseGeo,holeBasePlane,groundGeo,groundPlane;texture=(new THREE.TextureLoader).load("../assets/images/hall_ground.jpg"),texture3=(new THREE.TextureLoader).load("../assets/images/hall_ground.png"),objects=[],objectsLocked=[],state={animation:{play:!1},selectedBone:[]};var groupHole=new THREE.Group;groupHole.name="Hole";var groupBones=new THREE.Group;groupBones.name="Bones";var groupGridLevel=new THREE.Group;groupGridLevel.name="gridlavel",canvas=document.getElementById("renderer"),canvas_container=document.getElementsByClassName("renderer_container");var newGroup=document.getElementsByName("new_group")[0],_loadProject=document.getElementById("project");_loadProject.addEventListener("change",function(){openEditorManual(),loadingStart();for(var e=document.getElementsByClassName("progress").item(0),t=document.getElementsByClassName("progress_num").item(0),n=groupBones.children.length-1;n>=0;n--)groupBones.remove(groupBones.children[n]);objects=[];var o=this.files[0],r=new FileReader;r.onprogress=function(n){var o=parseInt(n.loaded/n.total*100,10);e.setAttribute("style","width:"+o+"%;"),t.innerHTML=o+"%"},r.onloadend=function(o){var a=new THREE.ObjectLoader,l=r.result;resultJson=JSON.parse(l);var d=a.parse(resultJson);for(n=d.children[1].children.length-1;n>=0;n--)d.children[1].children[n].traverse(function(e){objects.push(e)});for(groupHole.copy(d.children[0]),console.log(d),n=d.children[1].children.length-1;n>=0;n--)d.children[1].children[n].isGroup?(addGroupToGroupTree(null,d.children[1].children[n].uuid,d.children[1].children[n].name),loadedGroup=document.getElementById(d.children[1].children[n].uuid),d.children[1].children[n].traverse(function(e){e.isMesh&&addBoneToTree(e.name,e.uuid,!1,d.children[1].children[n].uuid)})):addBoneToTree(d.children[1].children[n].name,d.children[1].children[n].uuid,!0,null),groupBones.add(d.children[1].children[n]);groupGridLevel.copy(d.children[2]),closeEditor.click(),loadingEnd(),e.setAttribute("style","width:0%;"),t.innerHTML="0%"},r.readAsText(o),void 0!==gui.__folders.hole&&gui.removeFolder(gui.__folders.hole);var a=gui.addFolder("hole");a.add(groupHole.scale,"x",1,6).name("Width").listen(),a.add(groupHole.scale,"y",1,6).name("Depth").listen(),a.add(groupHole.scale,"z",1,6).name("Height").listen(),a.open},!1),init();var animateDiapo=document.getElementById("scene_animation");function init(){(scene=new THREE.Scene).background=new THREE.Color(13948116),(renderer=new THREE.WebGLRenderer({canvas:canvas,antialias:!0,clearAlpha:0})).setPixelRatio(window.devicePixelRatio),renderer.setSize(canvas_container[0].clientWidth,canvas_container[0].clientHeight),(camera=new THREE.PerspectiveCamera(60,canvas_container[0].clientWidth/canvas_container[0].clientHeight,1,4e3)).position.set(800,800,0),(controls=new THREE.OrbitControls(camera,canvas)).enableDamping=!0,controls.dampingFactor=.8,controls.screenSpacePanning=!1,controls.minDistance=10,controls.maxDistance=3e3,controls.maxPolarAngle=Math.PI,(controlObject=new THREE.TransformControls(camera,canvas)).addEventListener("dragging-changed",function(e){controls.enabled=!e.value}),scene.add(controlObject),scene.add(new THREE.AmbientLight(5263440));var e=new THREE.SpotLight(16777215,.5);e.position.set(0,1e3,1e3),e.angle=Math.PI,scene.add(e);var t=new THREE.SpotLight(16777215,.5);t.position.set(0,1e3,-1e3),t.angle=Math.PI,scene.add(t);var n=new THREE.AxesHelper(600);n.name="axesHelper",(gridHelper=new THREE.GridHelper(1200,12)).name="gridHelper",gridHelper.add(groupHole),gridHelper.add(groupBones),gridHelper.add(groupGridLevel),gridHelper.add(n),scene.add(gridHelper),(boxHelper=new THREE.BoxHelper(groupBones,16746752)).name="boxHelper",boxHelper.setFromObject(groupBones),boxHelper.matrixAutoUpdate=!0,scene.add(boxHelper);var o=(gui=new dat.GUI({autoPlace:!1})).addFolder();o.name="Control mode",o.open(),o.add(controlObject,"mode",{Translate:"translate",Rotate:"rotate"}).onChange(function(e){controlObject.setMode(e)}),(customContainer=document.getElementById("gui-container")).appendChild(gui.domElement),window.addEventListener("resize",onWindowResize,!1)}function onWindowResize(){camera.aspect=canvas_container[0].clientWidth/canvas_container[0].clientHeight,camera.updateProjectionMatrix(),renderer.setSize(canvas_container[0].clientWidth,canvas_container[0].clientHeight)}function animate(){requestAnimation=requestAnimationFrame(animate),state.animation.play?controls.autoRotate=!0:controls.autoRotate=!1,boxHelper.update(),controls.update(),renderer.render(scene,camera)}animateDiapo.addEventListener("click",function(){state.animation.play=!state.animation.play,state.animation.play?(this.children[0].setAttribute("class","icon-stop2"),this.style.background="#2e76b5",this.style.color="#fff"):(this.children[0].setAttribute("class","icon-play3"),this.style.background="#fff",this.style.color="#2e76b5")},!1),animate();var styeleState={subMenu:!1},menuDevlop=document.getElementById("menu-devlop"),closeEditor=document.getElementById("enable"),openEditor=document.getElementsByClassName("editor"),controlsElemLft=document.getElementsByClassName("sub_menu_lft"),controlsElemTop=document.getElementsByClassName("sub_menu_top"),i=0;menuDevlop.addEventListener("click",function(){for(var e=0;e<controlsElemLft.length;e++)styeleState.subMenu?(function(e){setTimeout(function(){n(e)},50*(e+1))}(e),function(e){setTimeout(function(){r(e)},50*(e+1))}(e)):(function(e){setTimeout(function(){t(e)},100*(e+1))}(e),function(e){setTimeout(function(){o(e)},100*(e+1))}(e));function t(e){controlsElemLft.item(e).setAttribute("style","transform: scale(1)")}function n(e){controlsElemLft.item(e).setAttribute("style","transform: scale(0);")}function o(e){controlsElemTop.item(e).setAttribute("style","transform: scale(1)")}function r(e){controlsElemTop.item(e).setAttribute("style","transform: scale(0);")}styeleState.subMenu=!styeleState.subMenu},!1),document.getElementById("add_hole").addEventListener("click",function(){openEditor[0].setAttribute("style","transform: scale(0.8,0.8) translateY(0px); zoom:1.2;opacity:1;z-index:402;;")},!1),document.getElementById("add_grid").addEventListener("click",function(){openHoleLevel(),openEditor[0].setAttribute("style","transform: scale(0.4,0.4) translateY(0px); zoom:2;opacity:1;z-index:402;")},!1),openEditorManual=(()=>{openEditor[0].setAttribute("style","transform: scale(0.8,0.8) translateY(0px); zoom:2;opacity:1;z-index:402;")}),closeEditor.addEventListener("click",function(){var e=this.parentElement;e.setAttribute("style","transform: translateY(-800px);"),e.children[1]&&e.children[1].remove()},!1);var imageHole=["geometry.png","cylinder.png"],sceneState={holeType:""};editor=document.getElementsByClassName("editor").item(0);var addHole=document.getElementById("add_hole");randomString=((e=6,t="0123456789abcdefghijklmnopqrstuvwxyz")=>{for(var n="_",o=e;o>0;--o)n+=t[Math.floor(Math.random()*t.length)];return n}),holeType=((e,t)=>{closeHoleSelector();var n={visible:!1,delete:function(){for(var e=groupHole.children.length-1;e>=0;e--)groupHole.remove(groupHole.children[e]);gui.removeFolder(gui.__folders.hole),groupHole.name="",sceneState.holeType=""}};if(!(void 0!==scene.getObjectByName(t)&sceneState.holeType===t)){sceneState.holeType=t;for(var o=groupHole.children.length-1;o>=0;o--)groupHole.remove(groupHole.children[o]);groupHole.scale.set(1,1,1),groupHole.name=t,void 0!==gui.__folders.hole&&gui.removeFolder(gui.__folders.hole);var r=gui.addFolder("hole");switch(r.add(groupHole.scale,"x",1,6).name("Width").onChange(function(e){groupGridLevel.scale.x=e}),r.add(groupHole.scale,"y",1,6).name("Depth").listen(),r.add(groupHole.scale,"z",1,6).name("Height").onChange(function(e){groupGridLevel.scale.z=e}),r.add(groupHole,"visible",[!1,!0]).onChange(function(e){groupHole.visible="true"==e}),r.add(n,"delete").onClick,r.open,t){case"geometry.png":holeBaseGeo=new THREE.CircleBufferGeometry(141.4213562373095,4,.75*Math.PI),(holeBasePlane=new THREE.Mesh(holeBaseGeo,new THREE.MeshPhongMaterial({map:texture3,opacity:.9,transparent:!0,side:THREE.DoubleSide}))).rotateX(-.5*Math.PI),groupHole.add(holeBasePlane),holeGeo=new THREE.CylinderBufferGeometry(141.4213562373095,141.4213562373095,100,4,0,!0,.75*Math.PI),(holePlane=new THREE.Mesh(holeGeo,new THREE.MeshPhongMaterial({map:texture3,opacity:.9,transparent:!0,side:THREE.DoubleSide}))).translateY(50),groupHole.add(holePlane),groundGeo=new THREE.RingBufferGeometry(141.4213562373095,200,4,1,.75*Math.PI),(groundPlane=new THREE.Mesh(groundGeo,new THREE.MeshPhongMaterial({map:texture,side:THREE.DoubleSide}))).translateY(100),groundPlane.rotateX(-.5*Math.PI),groupHole.add(groundPlane);break;case"cylinder.png":holeBaseGeo=new THREE.CircleBufferGeometry(100,128),cylBasePlane=new THREE.Mesh(holeBaseGeo,new THREE.MeshPhongMaterial({map:texture3,opacity:.9,transparent:!0,side:THREE.DoubleSide})),cylBasePlane.rotateX(.5*Math.PI),groupHole.add(cylBasePlane),holeGeo=new THREE.CylinderBufferGeometry(100,100,100,64,0,!0),(holePlane=new THREE.Mesh(holeGeo,new THREE.MeshPhongMaterial({map:texture3,opacity:.9,transparent:!0,side:THREE.DoubleSide}))).translateY(50),groupHole.add(holePlane),groundGeo=new THREE.RingBufferGeometry(100,150,80),(groundPlane=new THREE.Mesh(groundGeo,new THREE.MeshPhongMaterial({map:texture,side:THREE.DoubleSide}))).translateY(100),groundPlane.rotateX(-.5*Math.PI),groupHole.add(groundPlane)}}}),openHoleSelector=(()=>{if(2!==editor.childElementCount){var e=document.createElement("div");e.setAttribute("class","editorContain"),imageHole.forEach((t,n)=>{var o=document.createElement("div");o.setAttribute("class","type "+randomString()),o.addEventListener("click",e=>holeType(e,t),!1);var r=document.createElement("img");r.setAttribute("src","assets/images/hole/"+t),o.appendChild(r),e.appendChild(o)}),editor.appendChild(e)}}),closeHoleSelector=(()=>{document.getElementsByClassName("editorContain").item(0).setAttribute("style","transform:translate(-200px);opacity:0;"),setTimeout(function(){closeEditor.click()},400)}),openHoleLevel=(()=>{var e=document.createElement("div");e.setAttribute("class","editorContain");var t=document.createElement("div");t.setAttribute("class","holeLevel");var n=document.createElement("input");n.setAttribute("id","level_Number"),n.setAttribute("type","number"),n.setAttribute("name","levelNumber"),n.autofocus=!0,n.setAttribute("min","0"),n.setAttribute("max","600");var o=document.createElement("button");o.innerHTML="OK",o.setAttribute("id","validate_level"),t.appendChild(n),t.appendChild(o),e.appendChild(t),editor.appendChild(e),document.getElementById("validate_level").addEventListener("click",()=>validateLevel(),!1)}),loadingStart=(()=>{var e=document.createElement("div");e.setAttribute("class","loading");var t=document.createElement("div");t.setAttribute("class","loading_contain");var n=document.createElement("span");n.setAttribute("class","progress_num");var o=document.createElement("div");o.setAttribute("class","progress"),t.appendChild(o),t.appendChild(n),e.appendChild(t),editor.appendChild(e)}),loadingEnd=(()=>{document.getElementsByClassName("loading").item(0).remove()}),addHole.addEventListener("click",()=>openHoleSelector(),!1),validateLevel=(()=>{var e=document.getElementsByName("levelNumber");console.log(),e[0].valueAsNumber<0|e[0].valueAsNumber>600?closeEditor.click():(gridHelperLevel=new THREE.GridHelper(200,40,16777215,16777215*Math.random()),holeSize=groupHole.scale,gridHelperLevel.position.set(0,e[0].valueAsNumber,0),groupGridLevel.add(gridHelperLevel),closeEditor.click())});var guiFoldetState={objectSlected:void 0,open:!0},BonesSelect=document.getElementById("Bones"),boneList=document.getElementById("bonesList"),groupTree=document.getElementById("groupTree");function onDocumentTouchStart(e){var t=new THREE.Vector3(e.touches[0].clientX/canvas_container[0].clientWidth*2-1,-e.touches[0].clientY/canvas_container[0].clientHeight*2+1,.5),n=new THREE.Raycaster;n.setFromCamera(t,camera);var o=n.intersectObjects(objects);o.length>0&&(controlObject.attach(o[0].object),boneEditor(o[0].object),boxHelper.setFromObject(o[0].object),state.selectedBone=[],state.selectedBone.push(o[0].object))}function onDocumentMouseDown(e){var t=new THREE.Vector3(e.clientX/canvas_container[0].clientWidth*2-1,-e.clientY/canvas_container[0].clientHeight*2+1,.5),n=new THREE.Raycaster;n.setFromCamera(t,camera);var o=n.intersectObjects(objects);o.length>0&&(controlObject.attach(o[0].object),boneEditor(o[0].object),boxHelper.setFromObject(o[0].object),state.selectedBone=[],state.selectedBone.push(o[0].object))}function onBoneSelect(e){void 0!==gui.__folders[guiFoldetState.objectSlected]&gui.__folders[guiFoldetState.objectSlected]===e.name||(void 0!==gui.__folders[guiFoldetState.objectSlected]&gui.__folders[guiFoldetState.objectSlected]!==e.name?(gui.removeFolder(gui.__folders[guiFoldetState.objectSlected]),boneFolderEditor(e)):boneFolderEditor(e))}function boneEditor(e){for(var t=gui.__controllers.length,n=0;n<t;n++)gui.__controllers[0].remove();void 0!==gui.__folders["Bone Control"]&&gui.removeFolder(gui.__folders["Bone Control"]);var o=gui.addFolder("Bone Control");o.open();var r={color:e.material.color.getStyle(),delete:function(){controlObject.detach(e),document.getElementById(e.uuid).remove(),e.parent.remove(groupBones.getObjectByProperty("uuid",e.uuid));var t=objects.filter(t=>t.name!==e.name);objects=[...t]}};o.add(e.scale,"x",.1,5).name("Scale").onChange(function(t){e.scale.y=t,e.scale.z=t}),o.addColor(r,"color").onChange(function(){var t=new THREE.Color(r.color).getStyle();e.material.color.set(t)}),o.add(e.position,"x",-600,600),o.add(e.position,"y",-600,600),o.add(e.position,"z",-600,600),o.add(r,"delete").onClick}function addGroupToGroupTree(e,t,n){var o,r;void 0===t?(r=new THREE.Group,groupBones.add(r),o=r.uuid):o=t,console.log(t);var a=document.createElement("ul");a.setAttribute("id",o),a.setAttribute("class","drop-disabled group group-deselected"),a.addEventListener("dragenter",function(e){e.preventDefault(),this.children.group_name.readOnly=!1,this.classList.replace("drop-disabled","drop-enabled")}),a.addEventListener("dragend",function(e){e.preventDefault();var t=document.getElementsByClassName("group");[].forEach.call(t,e=>{e.classList.replace("drop-enabled","drop-disabled")})}),a.addEventListener("drop",function(e){e.preventDefault(),this.children.group_name.readOnly=!0;var t=e.dataTransfer.getData("text");this.insertAdjacentElement("beforeend",document.getElementById(t)),groupBones.getObjectByProperty("uuid",this.id).add(groupBones.getObjectByProperty("uuid",document.getElementById(t).id))});var l=document.createElement("span");l.className="icon-bin",l.addEventListener("click",function(){boxHelper.setFromObject(groupBones),controlObject.detach();var e=objects.filter(function(e){return this.indexOf(e)<0},groupBones.getObjectByProperty("uuid",this.parentElement.id).children);objects=[...e],groupBones.remove(groupBones.getObjectByProperty("uuid",this.parentElement.id)),this.parentElement.remove()},!1);var d=document.createElement("span");d.className="icon-pencil-square-o",d.addEventListener("click",function(){var e=this.nextSibling;e.readOnly=!1,e.focus()},!1);var i=document.createElement("span");i.className="icon-unlocked unlocked",i.id="locker",i.style.pointerEvents="all",i.addEventListener("click",function(){"icon-unlocked"===i.className.split(" ")[0]?(this.classList.replace("icon-unlocked","icon-lock"),this.classList.replace("unlocked","locked"),objects=objects.filter(e=>{if(groupBones.getObjectByProperty("uuid",e.uuid).parent.uuid!=this.parentElement.id)return e;objectsLocked.push(e),boxHelper.setFromObject(groupBones.getObjectByProperty("uuid",e.uuid).parent),controlObject.attach(groupBones.getObjectByProperty("uuid",e.uuid).parent),document.getElementById(e.uuid).draggable=!1,document.getElementById(e.uuid).style.pointerEvents="none",document.getElementById(e.uuid).style.opacity=.3,document.getElementById(e.uuid).classList.replace("selected","deselected")})):(this.classList.replace("icon-lock","icon-unlocked"),this.classList.replace("locked","unlocked"),objectsLocked=objectsLocked.filter(e=>{if(groupBones.getObjectByProperty("uuid",e.uuid).parent.uuid!=this.parentElement.id)return e;objects.push(e),document.getElementById(e.uuid).draggable=!0,document.getElementById(e.uuid).style.pointerEvents="all",document.getElementById(e.uuid).style.opacity=1}))},!1);var c=document.createElement("input");c.type="text",c.className="selected",c.readOnly=!0,c.name="group_name",c.placeholder="Group Name ...",c.value=void 0!==n?n:"",c.addEventListener("change",function(e){groupBones.getObjectByProperty("uuid",this.parentElement.id).name=e.target.value},!1),c.addEventListener("blur",function(){this.readOnly=!0}),c.addEventListener("click",function(e){var t=document.getElementsByClassName("group");[].forEach.call(t,e=>{e.classList.replace("group-selected","group-deselected")});var n=document.getElementsByClassName("bone");[].forEach.call(n,e=>{e.classList.replace("selected","deselected")});t=groupBones.getObjectByProperty("uuid",this.parentElement.id);this.parentElement.classList.replace("group-deselected","group-selected"),boxHelper.setFromObject(t),controlObject.attach(t)}),a.appendChild(i),a.appendChild(l),a.appendChild(d),a.appendChild(c),groupTree.appendChild(a)}function addBoneToTree(e,t,n,o){var r=document.createElement("li");r.textContent=e,r.id=t,r.className="bone deselected",r.setAttribute("draggable","true"),r.addEventListener("mouseover",function(e){controls.enabled=!1,controlObject.enabled=!1}),r.addEventListener("mouseleave",function(e){controls.enabled=!0,controlObject.enabled=!0}),r.addEventListener("dragstart",function(e){e.dataTransfer.setData("text",e.target.id),e.dataTransfer.setData("idparent",e.target.parentElement.id)}),r.addEventListener("click",function(e){var t=groupBones.getObjectByProperty("uuid",e.target.id),n=document.getElementsByClassName("group");[].forEach.call(n,e=>{e.classList.replace("group-selected","group-deselected")});var o=document.getElementsByClassName("bone");[].forEach.call(o,e=>{e.classList.replace("selected","deselected")}),this.classList.replace("deselected","selected"),controlObject.attach(t),boneEditor(t),boxHelper.setFromObject(t),state.selectedBone=[],state.selectedBone.push(t)},!1),!0===n&&boneList.appendChild(r),!1===n&&(group=document.getElementById(o),group.appendChild(r))}BonesSelect.addEventListener("change",function(){var e=new THREE.OBJLoader,t=this.files[0],n=new FileReader;n.onloadend=function(o){var r=n.result;e.parse(r).traverse(function(e){e.name=t.name,e.isMesh&&(objects.push(e),groupBones.add(e),addBoneToTree(t.name,e.uuid,!0,null))})},n.readAsText(t),closeEditor.click()},!1),canvas.addEventListener("touchstart",onDocumentTouchStart),canvas.addEventListener("click",onDocumentMouseDown),newGroup.addEventListener("click",addGroupToGroupTree,!1),boneList.addEventListener("drop",function(e){e.preventDefault();var t=e.dataTransfer.getData("text");this.appendChild(document.getElementById(t)),groupBones.add(groupBones.getObjectByProperty("uuid",document.getElementById(t).id))}),boneList.addEventListener("dragover",function(e){e.preventDefault()}),boneList.addEventListener("dragend",function(e){e.preventDefault();var t=document.getElementsByClassName("group");[].forEach.call(t,e=>{e.classList.replace("drop-enabled","drop-disabled")})});var exportScene=document.getElementById("export_scene");function exportOBJ(){saveString(gridHelper.toJSON(),"scene.json"),closeEditor.click()}exportScene.addEventListener("click",exportOBJ,!1);var link=document.createElement("a");function save(e,t){link.href=URL.createObjectURL(e),link.download=t,link.click(),closeEditor.click()}function saveString(e,t){save(new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),t)}link.style.display="none",document.body.appendChild(link);